#!/usr/bin/env sh
set -e

BRANCH=${PROTO_BRANCH:-main}

echo "Generating protos from branch ${BRANCH}..."

go generate ./...

# Generate mocks
mockery
rm -rf pkg/proto/**/*.pb.go pkg/proto/**/*.pb.gw.go pkg/proto/**/*.swagger.json
if ! buf generate https://github.com/xmtp/proto.git#branch=${BRANCH},subdir=proto; then
    echo "Failed to generate protobuf definitions"
    exit 1
fi
