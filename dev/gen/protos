#!/usr/bin/env bash

# Work always from the root directory
script_dir=$(dirname "$(realpath "$0")")
repo_root=$(realpath "${script_dir}/../../")
cd "${repo_root}" || exit

BRANCH=${PROTO_BRANCH:-main}
echo "Generating protos from branch ${BRANCH}..."

find pkg/proto -type f \( -name "*.pb.go" -o -name "*.pb.gw.go" -o -name "*.swagger.json" \) -exec rm -f {} +
if ! buf generate https://github.com/xmtp/proto.git#subdir=proto,branch="${BRANCH}"; then
    echo "Failed to generate protobuf definitions"
    exit 1
fi